<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake Agents Admin</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0d1117;color:#c9d1d9;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif;font-size:14px;line-height:1.5}
.login-screen{display:flex;align-items:center;justify-content:center;height:100vh;flex-direction:column;gap:16px}
.login-screen h1{font-size:24px;color:#58a6ff}
.login-screen input{padding:10px 16px;width:320px;background:#161b22;border:1px solid #30363d;border-radius:6px;color:#c9d1d9;font-size:14px;text-align:center}
.login-screen button{padding:10px 24px;background:#238636;border:none;border-radius:6px;color:#fff;font-size:14px;cursor:pointer}
.login-screen button:hover{background:#2ea043}
.login-error{color:#f85149;font-size:13px}
.login-step{display:flex;flex-direction:column;align-items:center;gap:12px}
.container{max-width:1400px;margin:0 auto;padding:16px}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid #21262d;margin-bottom:20px}
header h1{font-size:20px;color:#58a6ff}
header .actions{display:flex;gap:8px;align-items:center}
.tabs{display:flex;gap:4px;margin-bottom:20px;border-bottom:1px solid #21262d;padding-bottom:0}
.tab{padding:8px 16px;cursor:pointer;border:1px solid transparent;border-bottom:none;border-radius:6px 6px 0 0;color:#8b949e;font-size:13px}
.tab:hover{color:#c9d1d9}
.tab.active{background:#161b22;color:#58a6ff;border-color:#21262d}
.tab-content{display:none}
.tab-content.active{display:block}
.btn{padding:6px 14px;border:1px solid #30363d;border-radius:6px;background:#21262d;color:#c9d1d9;cursor:pointer;font-size:13px;white-space:nowrap}
.btn:hover{background:#30363d}
.btn-green{background:#238636;border-color:#238636;color:#fff}
.btn-green:hover{background:#2ea043}
.btn-red{background:#da3633;border-color:#da3633;color:#fff}
.btn-red:hover{background:#f85149}
.btn-blue{background:#1f6feb;border-color:#1f6feb;color:#fff}
.btn-blue:hover{background:#388bfd}
.btn-purple{background:#8957e5;border-color:#8957e5;color:#fff}
.btn-purple:hover{background:#a371f7}
.btn:disabled{opacity:.5;cursor:not-allowed}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:24px}
.card{background:#161b22;border:1px solid #21262d;border-radius:8px;padding:16px}
.card .label{font-size:12px;color:#8b949e;text-transform:uppercase;letter-spacing:.5px}
.card .value{font-size:28px;font-weight:700;color:#58a6ff;margin-top:4px}
.section{background:#161b22;border:1px solid #21262d;border-radius:8px;margin-bottom:20px;overflow:hidden}
.section-header{padding:12px 16px;border-bottom:1px solid #21262d;display:flex;align-items:center;justify-content:space-between}
.section-header h2{font-size:16px;color:#c9d1d9}
.section-body{padding:16px;overflow-x:auto}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:8px 12px;font-size:12px;color:#8b949e;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid #21262d}
td{padding:8px 12px;border-bottom:1px solid #21262d;font-size:13px}
tr:last-child td{border-bottom:none}
tr:hover{background:#1c2128}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600}
.badge-green{background:#0d421d;color:#3fb950}
.badge-red{background:#4a1e1e;color:#f85149}
.badge-yellow{background:#3d2e00;color:#d29922}
.badge-blue{background:#0c2d6b;color:#58a6ff}
.balance-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
.balance-card{background:#0d1117;border:1px solid #21262d;border-radius:6px;padding:14px}
.balance-card h3{font-size:14px;color:#58a6ff;margin-bottom:8px}
.balance-card .addr{font-size:11px;color:#8b949e;word-break:break-all}
.balance-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0}
.balance-row .lbl{color:#8b949e;font-size:13px}
.balance-row .val{color:#c9d1d9;font-weight:600}
.toast{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:8px;color:#fff;font-size:13px;z-index:9999;animation:slidein .3s ease}
.toast-ok{background:#238636}
.toast-err{background:#da3633}
@keyframes slidein{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
.hidden{display:none!important}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid #30363d;border-top-color:#58a6ff;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:4px}
@keyframes spin{to{transform:rotate(360deg)}}
.referral-list{max-height:400px;overflow-y:auto}
#lastUpdate{font-size:12px;color:#8b949e}
/* Logs */
.log-controls{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
.log-controls select,.log-controls input{padding:6px 10px;background:#0d1117;border:1px solid #30363d;border-radius:6px;color:#c9d1d9;font-size:13px}
.log-controls input{flex:1;min-width:200px}
#logPanel{background:#0d1117;border:1px solid #21262d;border-radius:6px;padding:12px;max-height:600px;overflow-y:auto;font-family:'SF Mono',Consolas,monospace;font-size:12px;line-height:1.6}
.log-entry{padding:2px 0;border-bottom:1px solid #161b22}
.log-debug{color:#8b949e}
.log-info{color:#c9d1d9}
.log-warn{color:#d29922}
.log-error{color:#f85149}
.log-important{color:#58a6ff;font-weight:600}
.log-ts{color:#6e7681;margin-right:8px}
#qrCanvas{margin:12px auto;display:block}
</style>
</head>
<body>

<!-- Login Screen -->
<div id="loginScreen" class="login-screen">
  <h1>Snake Agents Admin</h1>
  <!-- Step 1: Admin Key -->
  <div id="loginStep1" class="login-step">
    <input type="password" id="keyInput" placeholder="Enter admin key" onkeydown="if(event.key==='Enter')doLoginStep1()">
    <button onclick="doLoginStep1()">Login</button>
  </div>
  <!-- Step 2: TOTP -->
  <div id="loginStep2" class="login-step hidden">
    <div style="color:#8b949e;font-size:13px">Enter 6-digit authenticator code</div>
    <input type="text" id="totpInput" placeholder="000000" maxlength="6" pattern="[0-9]*" inputmode="numeric" onkeydown="if(event.key==='Enter')doLoginStep2()">
    <button onclick="doLoginStep2()">Verify</button>
    <canvas id="qrCanvas" class="hidden"></canvas>
  </div>
  <div id="loginError" class="login-error hidden"></div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden">
  <div class="container">
    <header>
      <h1>Snake Agents Admin</h1>
      <div class="actions">
        <span id="lastUpdate"></span>
        <button class="btn" onclick="refreshDashboard()">Refresh</button>
        <button class="btn btn-red" onclick="doLogout()">Logout</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" onclick="switchTab('overview')">Overview</div>
      <div class="tab" onclick="switchTab('logs')">Logs</div>
    </div>

    <!-- Tab: Overview -->
    <div id="tab-overview" class="tab-content active">

    <!-- Overview Cards -->
    <div class="cards">
      <div class="card"><div class="label">Total Bots</div><div class="value" id="statBots">-</div></div>
      <div class="card"><div class="label">Running</div><div class="value" id="statRunning">-</div></div>
      <div class="card"><div class="label">Total Matches</div><div class="value" id="statMatches">-</div></div>
      <div class="card"><div class="label">Users</div><div class="value" id="statUsers">-</div></div>
      <div class="card"><div class="label">Referrals</div><div class="value" id="statReferrals">-</div></div>
    </div>

    <!-- Fund Management -->
    <div class="section">
      <div class="section-header">
        <h2>Fund Management</h2>
        <div style="display:flex;gap:8px">
          <button class="btn btn-purple" id="btnConnectMM" onclick="connectMetaMask()">Connect Wallet</button>
          <button class="btn btn-blue" id="btnRefreshBal" onclick="refreshBalances()">Refresh Balances</button>
        </div>
      </div>
      <div class="section-body">
        <div class="balance-grid" id="balanceGrid">
          <div style="color:#8b949e">Click "Refresh Balances" to load on-chain data</div>
        </div>
      </div>
    </div>

    <!-- Danger Zone -->
    <div class="section" style="border-color:#ff4466">
      <div class="section-header" style="background:rgba(255,68,102,0.1)">
        <h2 style="color:#ff4466">Danger Zone</h2>
      </div>
      <div class="section-body" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <button class="btn" style="background:#ff4466;color:#fff;border:none" onclick="doFullReset()">Full Reset (Wipe All Data)</button>
        <span style="color:#8b949e;font-size:0.85rem">Clears all bots, leaderboard, history, match counters, referrals. Requires confirmation.</span>
      </div>
    </div>

    <!-- Arena Status -->
    <div class="section">
      <div class="section-header"><h2>Arena Status</h2></div>
      <div class="section-body">
        <table>
          <thead><tr><th>Arena</th><th>Type</th><th>State</th><th>Players</th><th>Time Left</th><th>Match</th><th>Viewers</th></tr></thead>
          <tbody id="arenaTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Bot Management -->
    <div class="section">
      <div class="section-header"><h2>Bot Management</h2></div>
      <div class="section-body">
        <table>
          <thead><tr><th>Name</th><th>Bot ID</th><th>Owner</th><th>Credits</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="botTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Match History -->
    <div class="section">
      <div class="section-header"><h2>Recent Matches (last 100)</h2></div>
      <div class="section-body">
        <table>
          <thead><tr><th>#</th><th>Arena</th><th>Winner</th><th>Score</th><th>Players</th><th>Time</th></tr></thead>
          <tbody id="matchTable"></tbody>
        </table>
      </div>
    </div>

    <!-- Referral Stats -->
    <div class="section">
      <div class="section-header"><h2>Referral Stats</h2></div>
      <div class="section-body referral-list">
        <table>
          <thead><tr><th>User</th><th>Inviter</th><th>Registered</th></tr></thead>
          <tbody id="referralTable"></tbody>
        </table>
      </div>
    </div>

    </div><!-- end tab-overview -->

    <!-- Tab: Logs -->
    <div id="tab-logs" class="tab-content">
      <div class="section">
        <div class="section-header">
          <h2>Server Logs</h2>
          <label style="font-size:12px;color:#8b949e"><input type="checkbox" id="logAutoRefresh" checked> Auto-refresh (5s)</label>
        </div>
        <div class="section-body">
          <div class="log-controls">
            <select id="logLevel">
              <option value="">All Levels</option>
              <option value="debug">Debug</option>
              <option value="info">Info</option>
              <option value="warn">Warn</option>
              <option value="error">Error</option>
              <option value="important">Important</option>
            </select>
            <input type="text" id="logSearch" placeholder="Search logs...">
            <button class="btn" onclick="fetchLogs(true)">Refresh</button>
            <button class="btn btn-red" onclick="clearLogPanel()">Clear</button>
          </div>
          <div id="logPanel"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const API_BASE = '';
let adminKey = sessionStorage.getItem('snake_admin_key') || '';
let totpSession = sessionStorage.getItem('snake_totp_session') || '';
let refreshTimer = null;
let logTimer = null;
let lastLogTs = 0;
let mmProvider = null;
let mmSigner = null;

// Contract ABIs for MetaMask withdraw
const WITHDRAW_ABI_PM = ['function withdrawPlatformFees() external'];
const WITHDRAW_ABI_MKT = ['function withdrawFees() external'];
const WITHDRAW_ABI_REG = ['function withdrawFees() external'];

// Dynamic chain config — loaded from /api/chain-info
let CHAIN_CONFIG = {
  chainId: '0x14a34',
  chainName: 'Base Sepolia',
  nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
  rpcUrls: ['https://sepolia.base.org'],
  blockExplorerUrls: ['https://sepolia.basescan.org']
};
let CHAIN_ID_HEX = '0x14a34';
let CHAIN_ID_NUM = 84532;

// Fetch chain info from backend
fetch('/api/chain-info').then(r => r.json()).then(info => {
  CHAIN_ID_NUM = info.chainId;
  CHAIN_ID_HEX = '0x' + info.chainId.toString(16);
  CHAIN_CONFIG = {
    chainId: CHAIN_ID_HEX,
    chainName: info.chainName || (info.chainId === 8453 ? 'Base' : 'Base Sepolia'),
    nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
    rpcUrls: [info.rpcUrl || 'https://sepolia.base.org'],
    blockExplorerUrls: [info.blockExplorer || 'https://sepolia.basescan.org']
  };
}).catch(e => console.warn('Failed to load chain-info:', e));

// --- Auth ---
let loginAttempts = 0;
let loginLocked = false;

async function doLoginStep1() {
  if (loginLocked) return;
  const key = document.getElementById('keyInput').value.trim();
  if (!key) return;
  adminKey = key;

  try {
    // Check if TOTP is enabled
    const setup = await fetch(API_BASE + '/api/admin/totp-setup', {
      headers: { 'x-api-key': adminKey }
    }).then(r => r.json());

    if (setup.enabled) {
      // Show TOTP step
      document.getElementById('loginStep1').classList.add('hidden');
      document.getElementById('loginStep2').classList.remove('hidden');
      document.getElementById('totpInput').focus();

      // Show QR code if URI available (first-time setup)
      if (setup.uri && typeof QRCode !== 'undefined') {
        const canvas = document.getElementById('qrCanvas');
        canvas.classList.remove('hidden');
        QRCode.toCanvas(canvas, setup.uri, { width: 200, margin: 2, color: { dark: '#c9d1d9', light: '#0d1117' } });
      }
    } else {
      // No TOTP — direct login
      totpSession = 'no-totp';
      await finishLogin();
    }
  } catch (e) {
    showLoginError(e);
  }
}

async function doLoginStep2() {
  const code = document.getElementById('totpInput').value.trim();
  if (!code || code.length !== 6) return;

  try {
    const r = await fetch(API_BASE + '/api/admin/verify-totp', {
      method: 'POST',
      headers: { 'x-api-key': adminKey, 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    }).then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); });

    if (r.ok && r.session) {
      totpSession = r.session;
      await finishLogin();
    } else {
      throw new Error('Invalid code');
    }
  } catch (e) {
    showLoginError(e);
  }
}

async function finishLogin() {
  try {
    const r = await apiFetch('/api/admin/dashboard-data');
    if (r.ok) {
      loginAttempts = 0;
      sessionStorage.setItem('snake_admin_key', adminKey);
      sessionStorage.setItem('snake_totp_session', totpSession);
      showDashboard();
      return;
    }
  } catch (e) {
    showLoginError(e);
  }
}

function showLoginError(e) {
  const errEl = document.getElementById('loginError');
  loginAttempts++;
  if (e.message && e.message.includes('429')) {
    errEl.textContent = 'Too many attempts. Please wait before retrying.';
  } else if (e.message && e.message.includes('403')) {
    errEl.textContent = 'TOTP verification required.';
  } else {
    const delaySec = Math.min(30, Math.pow(2, loginAttempts));
    errEl.textContent = `Auth failed. Wait ${delaySec}s before retrying.`;
    loginLocked = true;
    setTimeout(() => { loginLocked = false; }, delaySec * 1000);
  }
  errEl.classList.remove('hidden');
}

function doLogout() {
  adminKey = '';
  totpSession = '';
  sessionStorage.removeItem('snake_admin_key');
  sessionStorage.removeItem('snake_totp_session');
  clearInterval(refreshTimer);
  clearInterval(logTimer);
  document.getElementById('dashboard').classList.add('hidden');
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('loginStep1').classList.remove('hidden');
  document.getElementById('loginStep2').classList.add('hidden');
  document.getElementById('keyInput').value = '';
  document.getElementById('qrCanvas').classList.add('hidden');
}

function showDashboard() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  refreshDashboard();
  refreshTimer = setInterval(refreshDashboard, 30000);
}

// --- Tabs ---
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
  if (tab === 'logs') {
    fetchLogs(true);
    logTimer = setInterval(() => {
      if (document.getElementById('logAutoRefresh').checked) fetchLogs();
    }, 5000);
  } else {
    clearInterval(logTimer);
  }
}

// --- API Helper ---
async function apiFetch(path, opts = {}) {
  const headers = { 'x-api-key': adminKey, 'Content-Type': 'application/json', ...(opts.headers || {}) };
  if (totpSession) headers['x-totp-session'] = totpSession;
  const resp = await fetch(API_BASE + path, { ...opts, headers });
  if (!resp.ok) throw new Error('HTTP ' + resp.status);
  return resp.json();
}

// --- Dashboard Data ---
async function refreshDashboard() {
  try {
    const data = await apiFetch('/api/admin/dashboard-data');
    document.getElementById('statBots').textContent = data.totalBots;
    document.getElementById('statRunning').textContent = data.runningBots;
    document.getElementById('statMatches').textContent = data.totalMatches;
    document.getElementById('statUsers').textContent = data.totalUsers;
    document.getElementById('statReferrals').textContent = data.totalReferrals;
    document.getElementById('lastUpdate').textContent = 'Updated: ' + new Date().toLocaleTimeString();

    renderArenas(data.arenaStatus || []);
    renderBots(data.bots || []);
    renderMatches(data.recentMatches || []);
    renderReferrals(data.referralUsers || {});
  } catch (e) {
    if (e.message.includes('401') || e.message.includes('403')) { doLogout(); return; }
    toast('Failed to refresh: ' + e.message, true);
  }
}

// --- Arenas ---
function renderArenas(arenas) {
  const tb = document.getElementById('arenaTable');
  if (!arenas.length) { tb.innerHTML = '<tr><td colspan="7" style="color:#8b949e">No active arenas</td></tr>'; return; }
  tb.innerHTML = arenas.map(a => `<tr>
    <td>${esc(a.id)}</td>
    <td>${esc(a.type)}</td>
    <td><span class="badge ${a.gameState==='PLAYING'?'badge-green':a.gameState==='COUNTDOWN'?'badge-yellow':'badge-blue'}">${esc(a.gameState)}</span></td>
    <td>${a.players}/${a.maxPlayers}</td>
    <td>${a.matchTimeLeft}s</td>
    <td>${esc(a.displayMatchId||'')}</td>
    <td>${a.clients}</td>
  </tr>`).join('');
}

// --- Bots ---
function renderBots(bots) {
  const tb = document.getElementById('botTable');
  if (!bots.length) { tb.innerHTML = '<tr><td colspan="7" style="color:#8b949e">No bots</td></tr>'; return; }
  tb.innerHTML = bots.map(b => `<tr>
    <td>${esc(b.name)}</td>
    <td style="font-size:11px;color:#8b949e">${esc(b.botId)}</td>
    <td style="font-size:11px">${shortAddr(b.owner)}</td>
    <td>${b.unlimited ? '<span class="badge badge-blue">Unlimited</span>' : b.credits}</td>
    <td>${esc(b.botType)}</td>
    <td>${b.workerAlive ? '<span class="badge badge-green">Running</span>' : '<span class="badge badge-red">Stopped</span>'}</td>
    <td>
      ${b.workerAlive
        ? `<button class="btn btn-red" onclick="botAction('stop','${esc(b.botId)}')">Stop</button>`
        : `<button class="btn btn-green" onclick="botAction('start','${esc(b.botId)}')">Start</button>`}
      <button class="btn" onclick="botAction('topup','${esc(b.botId)}')">+5 Credits</button>
    </td>
  </tr>`).join('');
}

async function botAction(action, botId) {
  try {
    if (action === 'start') {
      await apiFetch('/api/bot/start', { method: 'POST', body: JSON.stringify({ botId }) });
      toast('Bot started: ' + botId);
    } else if (action === 'stop') {
      await apiFetch('/api/bot/stop', { method: 'POST', body: JSON.stringify({ botId }) });
      toast('Bot stopped: ' + botId);
    } else if (action === 'topup') {
      await apiFetch('/api/bot/topup', { method: 'POST', body: JSON.stringify({ botId, amount: 0.01 }) });
      toast('Credits added: ' + botId);
    }
    setTimeout(refreshDashboard, 500);
  } catch (e) {
    toast('Action failed: ' + e.message, true);
  }
}

// --- Matches ---
function renderMatches(matches) {
  const tb = document.getElementById('matchTable');
  if (!matches.length) { tb.innerHTML = '<tr><td colspan="6" style="color:#8b949e">No matches yet</td></tr>'; return; }
  tb.innerHTML = matches.map(m => `<tr>
    <td>${m.matchId || '-'}</td>
    <td>${esc(m.arenaId||'')}</td>
    <td>${esc(m.winner||'')}</td>
    <td>${m.score||0}</td>
    <td>${(m.participants||[]).length}</td>
    <td style="font-size:12px;color:#8b949e">${m.timestamp ? new Date(m.timestamp).toLocaleString() : ''}</td>
  </tr>`).join('');
}

// --- Referrals ---
function renderReferrals(users) {
  const tb = document.getElementById('referralTable');
  const entries = Object.entries(users);
  if (!entries.length) { tb.innerHTML = '<tr><td colspan="3" style="color:#8b949e">No referrals</td></tr>'; return; }
  tb.innerHTML = entries.map(([addr, info]) => `<tr>
    <td style="font-size:12px">${shortAddr(addr)}</td>
    <td style="font-size:12px">${shortAddr(info.inviter||'')}</td>
    <td style="font-size:12px;color:#8b949e">${info.registeredAt ? new Date(info.registeredAt).toLocaleString() : ''}</td>
  </tr>`).join('');
}

// --- Balances ---
async function refreshBalances() {
  const btn = document.getElementById('btnRefreshBal');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>Loading...';
  try {
    const data = await apiFetch('/api/admin/balances');
    const grid = document.getElementById('balanceGrid');
    grid.innerHTML = '';

    // Backend Wallet
    if (data.backendWallet) {
      grid.innerHTML += balanceCard('Backend Wallet', data.backendWallet.address, [
        ['ETH', data.backendWallet.ethBalance]
      ]);
    }

    // Contracts
    const contracts = [
      ['Bot Registry', 'botRegistry'],
      ['PariMutuel', 'pariMutuel'],
      ['Bot Marketplace', 'botMarketplace']
    ];
    for (const [label, key] of contracts) {
      const c = data[key];
      if (!c) continue;
      const rows = [['ETH', c.ethBalance]];
      if (c.usdcBalance) rows.push(['USDC', c.usdcBalance]);
      if (c.accumulatedFees && c.accumulatedFees !== 'N/A') {
        rows.push(['Withdrawable Fees', c.accumulatedFees + ' ETH']);
      }
      const hasAccumFees = (key === 'pariMutuel' || key === 'botMarketplace') && c.accumulatedFees && c.accumulatedFees !== 'N/A' && parseFloat(c.accumulatedFees) > 0;
      const hasEthBalance = parseFloat(c.ethBalance) > 0;
      const canWithdraw = key === 'botRegistry' ? hasEthBalance : hasAccumFees;
      const withdrawBtn = canWithdraw && mmSigner
        ? `<button class="btn btn-green" style="margin-top:8px;width:100%" onclick="doWithdrawMM('${key}','${esc(c.address)}')">Withdraw via Wallet</button>`
        : canWithdraw
        ? `<button class="btn" style="margin-top:8px;width:100%;opacity:0.5" disabled title="Connect wallet first">Connect Wallet to Withdraw</button>`
        : '';
      grid.innerHTML += balanceCard(label, c.address, rows, withdrawBtn);
    }
  } catch (e) {
    toast('Balance query failed: ' + e.message, true);
  }
  btn.disabled = false;
  btn.textContent = 'Refresh Balances';
}

function balanceCard(title, addr, rows, extra='') {
  return `<div class="balance-card">
    <h3>${esc(title)}</h3>
    <div class="addr">${esc(addr)}</div>
    ${rows.map(([l,v]) => `<div class="balance-row"><span class="lbl">${esc(l)}</span><span class="val">${esc(String(v))}</span></div>`).join('')}
    ${extra}
  </div>`;
}

// --- MetaMask Withdraw ---
async function connectMetaMask() {
  if (typeof window.ethereum === 'undefined') {
    toast('MetaMask not detected', true);
    return;
  }
  try {
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    // Switch to target chain
    try {
      await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_ID_HEX }] });
    } catch (switchErr) {
      // Chain not added yet — add it
      if (switchErr.code === 4902) {
        await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [CHAIN_CONFIG] });
      } else {
        throw switchErr;
      }
    }
    mmProvider = new ethers.providers.Web3Provider(window.ethereum);
    mmSigner = mmProvider.getSigner();
    const addr = await mmSigner.getAddress();
    const network = await mmProvider.getNetwork();
    document.getElementById('btnConnectMM').textContent = shortAddr(addr) + ' (' + CHAIN_CONFIG.chainName + ')';
    document.getElementById('btnConnectMM').classList.remove('btn-purple');
    document.getElementById('btnConnectMM').classList.add('btn-green');
    toast('Wallet connected on ' + CHAIN_CONFIG.chainName + ': ' + shortAddr(addr));
    refreshBalances();
  } catch (e) {
    toast('Wallet connection failed: ' + e.message, true);
  }
}

async function doWithdrawMM(contractKey, contractAddr) {
  if (!mmSigner) { toast('Connect wallet first', true); return; }
  // Verify we're on the correct chain
  const network = await mmProvider.getNetwork();
  if (network.chainId !== CHAIN_ID_NUM) {
    toast('Please switch to ' + CHAIN_CONFIG.chainName + ' chain first', true);
    try {
      await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CHAIN_ID_HEX }] });
      mmProvider = new ethers.providers.Web3Provider(window.ethereum);
      mmSigner = mmProvider.getSigner();
    } catch (e) { return; }
  }
  if (!confirm(`Withdraw fees from ${contractKey}? Only the owner wallet can execute this.`)) return;
  try {
    let contract, tx;
    if (contractKey === 'pariMutuel') {
      contract = new ethers.Contract(contractAddr, WITHDRAW_ABI_PM, mmSigner);
      tx = await contract.withdrawPlatformFees();
    } else if (contractKey === 'botMarketplace') {
      contract = new ethers.Contract(contractAddr, WITHDRAW_ABI_MKT, mmSigner);
      tx = await contract.withdrawFees();
    } else if (contractKey === 'botRegistry') {
      contract = new ethers.Contract(contractAddr, WITHDRAW_ABI_REG, mmSigner);
      tx = await contract.withdrawFees();
    } else {
      toast('Unknown contract: ' + contractKey, true);
      return;
    }
    toast('TX submitted: ' + tx.hash);
    await tx.wait();
    toast('Withdraw confirmed!');
    setTimeout(refreshBalances, 2000);
  } catch (e) {
    const reason = e.reason || e.message || 'Unknown error';
    toast('Withdraw failed: ' + reason, true);
  }
}

// --- Logs ---
async function fetchLogs(reset) {
  if (reset) lastLogTs = 0;
  try {
    const level = document.getElementById('logLevel').value;
    const url = '/api/admin/logs?since=' + lastLogTs + (level ? '&level=' + level : '');
    const data = await apiFetch(url);
    if (!data.logs || data.logs.length === 0) return;

    const search = (document.getElementById('logSearch').value || '').toLowerCase();
    const panel = document.getElementById('logPanel');
    const wasAtBottom = panel.scrollTop + panel.clientHeight >= panel.scrollHeight - 20;

    for (const entry of data.logs) {
      if (search && !entry.msg.toLowerCase().includes(search)) continue;
      const div = document.createElement('div');
      div.className = 'log-entry log-' + entry.level;
      const ts = new Date(entry.ts).toLocaleTimeString();
      div.innerHTML = `<span class="log-ts">${ts}</span>[${entry.level.toUpperCase()}] ${esc(entry.msg)}`;
      panel.appendChild(div);
      lastLogTs = Math.max(lastLogTs, entry.ts);
    }

    // Auto-scroll if user was at bottom
    if (wasAtBottom) panel.scrollTop = panel.scrollHeight;
  } catch (e) {
    // silent
  }
}

function clearLogPanel() {
  document.getElementById('logPanel').innerHTML = '';
  lastLogTs = 0;
}

// --- Utils ---
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function shortAddr(a) { return a && a.length > 10 ? a.slice(0,6)+'...'+a.slice(-4) : (a||'-'); }
function toast(msg, isErr) {
  const el = document.createElement('div');
  el.className = 'toast ' + (isErr ? 'toast-err' : 'toast-ok');
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// --- Full Reset ---
async function doFullReset() {
  if (!confirm('WARNING: This will DELETE ALL DATA (bots, leaderboard, history, referrals).\n\nAre you sure?')) return;
  const typed = prompt('Type FULL_RESET to confirm:');
  if (typed !== 'FULL_RESET') { toast('Reset cancelled', true); return; }
  try {
    const data = await apiFetch('/api/admin/full-reset', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ confirm: 'FULL_RESET' })
    });
    if (data.ok) {
      toast('Full reset complete! Restarting server...');
      // Auto-restart via PM2 would be ideal, but just refresh after delay
      setTimeout(() => location.reload(), 3000);
    } else {
      toast('Reset failed: ' + (data.error || 'unknown'), true);
    }
  } catch (e) { toast('Reset failed: ' + e.message, true); }
}

// --- Init ---
if (adminKey) {
  apiFetch('/api/admin/dashboard-data').then(data => {
    if (data.ok) showDashboard();
    else doLogout();
  }).catch(() => doLogout());
} else {
  document.getElementById('loginScreen').classList.remove('hidden');
}
</script>
</body>
</html>
