# Snake Agents â€” ä»£ç å®¡è®¡æŠ¥å‘Š v2

**æ—¥æœŸ**: 2026-02-26
**å®¡è®¡èŒƒå›´**: `server.js` (~4406 è¡Œ) + `src/App.tsx` (~2601 è¡Œ)
**å®¡è®¡äºº**: Claude (è‡ªåŠ¨åŒ–å®¡è®¡)

---

## æ‘˜è¦

æœ¬æ¬¡å®¡è®¡åŸºäº v1 æŠ¥å‘Šï¼ˆ2026-02-24ï¼‰çš„åŸºç¡€ä¸Šè¿›è¡Œäº†å…¨é¢å¤æŸ¥ã€‚v1 ä¸­å‘ç°çš„éƒ¨åˆ†é—®é¢˜å·²ä¿®å¤ï¼ŒåŒæ—¶å‘ç°äº†æ–°çš„é—®é¢˜ã€‚

| ä¸¥é‡åº¦ | æ•°é‡ | å·²ä¿®å¤ |
|--------|------|--------|
| ğŸ”´ Critical | 3 | 0 |
| ğŸŸ  High | 8 | 1 |
| ğŸŸ¡ Medium | 9 | 0 |
| ğŸŸ¢ Low | 7 | 0 |
| **æ€»è®¡** | **27** | **1** |

---

## v1 æŠ¥å‘Šä¿®å¤çŠ¶æ€

| v1 ID | é—®é¢˜ | çŠ¶æ€ |
|-------|------|------|
| C1 | botId æœªå®šä¹‰å˜é‡ | âœ… å·²ä¿®å¤ |
| C2 | ç§¯åˆ†æ³¨å†Œç«æ€ | âš ï¸ æœªä¿®å¤ |
| C3 | Bot credit æ‰£å‡ç«æ€ | âš ï¸ æœªä¿®å¤ |
| H1 | Bot è„šæœ¬éªŒè¯æ­£åˆ™ç»•è¿‡ | âš ï¸ æœªä¿®å¤ |
| H2 | Edit token ä½¿ç”¨åä¸é”€æ¯ | âš ï¸ æœªä¿®å¤ |
| H4 | USDC æ— é™æˆæƒ | âš ï¸ æœªä¿®å¤ |
| H8 | å‰ç«¯ç¡¬ç¼–ç  gas å€¼ | âœ… å·²ä¿®å¤ï¼ˆ8å¤„ï¼‰ï¼ŒğŸ”§ æœ¬æ¬¡ä¿®å¤æœ€å1å¤„ |

---

## ğŸ”´ Critical (3) â€” æ–°å‘ç°

### C-1: matchNumber ç¢°æ’é£é™© â€” admin reset ä¸é‡ç½® nextMatch
**æ–‡ä»¶**: `server.js` ~è¡Œ 3510 (`/api/admin/room/:roomId/reset`)
**æè¿°**: Admin reset ç«¯ç‚¹å°†æˆ¿é—´çŠ¶æ€é‡ç½®ä¸º COUNTDOWNï¼Œä½†ä¸æ¸…é™¤ `this.nextMatch`ã€‚å¦‚æœåœ¨ PLAYING é˜¶æ®µ resetï¼Œ`nextMatch` ä¸­é¢„åˆ›å»ºçš„ matchId ä»ç„¶å­˜åœ¨ï¼Œè€Œ `startCountdown()` åˆä¼šæ¶ˆè´¹å®ƒï¼Œä½†æ­¤æ—¶é“¾ä¸Šçš„ `createMatch` å¯èƒ½å¯¹åº”çš„æ˜¯å·²è¢« reset çš„æ¯”èµ›æ—¶é—´ã€‚
**å½±å“**: é“¾ä¸Š match çš„ startTime ä¸å®é™…æ¸¸æˆæ—¶é—´ä¸åŒ¹é…ï¼Œå¯¼è‡´æŠ•æ³¨çª—å£é”™è¯¯ã€‚
**ä¿®å¤å»ºè®®**: reset æ—¶æ‰§è¡Œ `this.nextMatch = null`ã€‚

### C-2: Admin create-on-chain ç»•è¿‡ TX é˜Ÿåˆ—
**æ–‡ä»¶**: `server.js` ~è¡Œ 3606 (`/api/admin/room/:roomId/create-on-chain`)
**æè¿°**: ç›´æ¥è°ƒç”¨ `pariMutuelContract.createMatch()` è€Œä¸ç»è¿‡ `enqueueTx()`ï¼Œä¸é˜Ÿåˆ—ä¸­çš„å…¶ä»–äº¤æ˜“å¯èƒ½äº§ç”Ÿ nonce å†²çªã€‚
**å½±å“**: äº¤æ˜“å¤±è´¥æˆ– nonce gap å¯¼è‡´åç»­æ‰€æœ‰äº¤æ˜“å¡ä½ã€‚
**ä¿®å¤å»ºè®®**: æ”¹ç”¨ `enqueueTxAsync()` åŒ…è£…ã€‚

### C-3: matchNumber æœªç‹¬ç«‹æŒä¹…åŒ–
**æ–‡ä»¶**: `server.js` ~è¡Œ 640
**æè¿°**: `matchNumber` åœ¨å†…å­˜ä¸­ç»´æŠ¤ã€‚è¿›ç¨‹é‡å¯æ—¶ä» `Math.floor(Date.now()/1000)` é‡æ–°ç”Ÿæˆã€‚å¦‚æœ PM2 crash loopï¼ˆ1ç§’å†…å¤šæ¬¡é‡å¯ï¼‰ï¼Œå¯èƒ½ç”Ÿæˆç›¸åŒ matchNumberã€‚
**å½±å“**: é“¾ä¸Š matchId ç¢°æ’ â†’ `createMatch` revertã€‚
**ä¿®å¤å»ºè®®**: å°† `matchNumber` å†™å…¥æŒä¹…åŒ–æ–‡ä»¶ï¼Œé‡å¯æ—¶è¯»å–å¹¶é€’å¢ã€‚

---

## ğŸŸ  High (8)

### H-1: âœ… å·²ä¿®å¤ â€” é—æ¼çš„ç¡¬ç¼–ç  gas (App.tsx handleCancel)
**æ–‡ä»¶**: `src/App.tsx` ~è¡Œ 1952
**æè¿°**: `MarketplacePage` çš„ `handleCancel` å‡½æ•°ä¸­æœ‰ `gas: 200_000n` ç¡¬ç¼–ç ã€‚
**çŠ¶æ€**: âœ… æœ¬æ¬¡å·²ç§»é™¤ã€‚

### H-2: ç§¯åˆ†æ³¨å†Œå¥–åŠ±å¹¶å‘ç«æ€ï¼ˆv1 C2 æœªä¿®å¤ï¼‰
**æ–‡ä»¶**: `server.js` æ³¨å†Œæµç¨‹
**æè¿°**: ä¸¤ä¸ªå¹¶å‘ `/api/bot/register` è¯·æ±‚å¯åŒæ—¶é€šè¿‡ `alreadyClaimed` æ£€æŸ¥ï¼Œå„è‡ªå‘æ”¾ 200 ç§¯åˆ†ã€‚
**åˆ©ç”¨æ–¹å¼**: è„šæœ¬åŒæ—¶å‘ 2-5 ä¸ªæ³¨å†Œè¯·æ±‚ â†’ ä¸€æ¬¡æ³¨å†Œè· 400-1000 ç§¯åˆ†ã€‚
**ä¿®å¤å»ºè®®**: åœ¨ `awardScore` å†…éƒ¨ç”¨åŒæ­¥æ ‡è®°æˆ–åŸå­æ£€æŸ¥ã€‚

### H-3: Bot credit æ‰£å‡ç«æ€ï¼ˆv1 C3 æœªä¿®å¤ï¼‰
**æ–‡ä»¶**: `server.js` ~è¡Œ 1886
**æè¿°**: `credits <= 0` æ£€æŸ¥å’Œ `credits -= 1` éåŸå­æ“ä½œã€‚
**åˆ©ç”¨æ–¹å¼**: bot åªå‰© 1 creditï¼ŒåŒæ—¶å‘ 20 ä¸ª join è¯·æ±‚ â†’ credit è¢«æ‰£åˆ° -19ã€‚
**ä¿®å¤å»ºè®®**: å…ˆæ‰£åæ£€æŸ¥ï¼š`credits -= 1; if (credits < 0) { credits += 1; return fail; }`

### H-4: displayIdToMatchId æ— é™å¢é•¿
**æ–‡ä»¶**: `server.js` ~è¡Œ 654
**æè¿°**: `displayIdToMatchId` å¯¹è±¡åªå¢ä¸å‡ï¼Œæ°¸è¿œä¸ä¼šæ¸…ç†æ—§æ¡ç›®ã€‚
**å½±å“**: å†…å­˜æ³„æ¼ï¼ˆç¼“æ…¢ä½†æŒç»­ï¼‰ã€‚
**ä¿®å¤å»ºè®®**: ä½¿ç”¨ LRU ç¼“å­˜æˆ–å®šæœŸæ¸…ç†è¶…è¿‡ N å¤©çš„æ¡ç›®ã€‚

### H-5: usedEntryTxHashes æ°¸ä¸æ¸…ç†
**æ–‡ä»¶**: `server.js` ~è¡Œ 651
**æè¿°**: `usedEntryTxHashes` Set ç”¨äºé˜²æ­¢é‡æ”¾æ”»å‡»ï¼Œä½†ä»ä¸åˆ é™¤æ—§æ¡ç›®ã€‚
**å½±å“**: ä¸ H-4 ç±»ä¼¼çš„å†…å­˜æ³„æ¼ã€‚
**ä¿®å¤å»ºè®®**: å®šæœŸæ¸…ç†è¶…è¿‡ 24 å°æ—¶çš„æ¡ç›®ï¼ˆéœ€é…åˆæ—¶é—´æˆ³è®°å½•ï¼‰ã€‚

### H-6: Credits å…ˆæ‰£åç¡®è®¤
**æ–‡ä»¶**: `server.js` ~è¡Œ 2758 (`handleCompetitiveEntry`)
**æè¿°**: ç«æŠ€åœºå…¥åœºå…ˆæ‰£ creditsï¼Œç„¶åæ‰æ£€æŸ¥ç©ºä½ã€‚æ— ç©ºä½æ—¶ credits å·²æ‰£ä½†æœªå…¥åœºã€‚
**å½±å“**: ç”¨æˆ·ä¸¢å¤± creditsã€‚
**ä¿®å¤å»ºè®®**: å…ˆæ£€æŸ¥ç©ºä½å†æ‰£é™¤ï¼›æˆ–å¤±è´¥æ—¶å›æ»šã€‚

### H-7: /api/score å’Œ /api/bet ç«¯ç‚¹ç¼ºå°‘è®¤è¯
**æ–‡ä»¶**: `server.js` ~è¡Œ 3200-3300
**æè¿°**: è¿™äº›ç«¯ç‚¹æ— è®¤è¯ï¼Œä»»ä½•äººå¯è°ƒç”¨ã€‚
**å½±å“**: æ½œåœ¨ä½œå¼Šé£é™©ã€‚
**ä¿®å¤å»ºè®®**: æ·»åŠ  API key æˆ– HMAC ç­¾åéªŒè¯ã€‚

### H-8: settledOnChainMatchIds O(n) æŸ¥æ‰¾
**æ–‡ä»¶**: `server.js` ~è¡Œ 648
**æè¿°**: `settledOnChainMatchIds` æ˜¯æ•°ç»„ï¼Œä½¿ç”¨ `.includes()` æŸ¥æ‰¾ã€‚
**å½±å“**: éšæ¯”èµ›å¢å¤šæ€§èƒ½ä¸‹é™ã€‚
**ä¿®å¤å»ºè®®**: æ”¹ä¸º `Set`ã€‚

---

## ğŸŸ¡ Medium (9)

### M-1: saveHistory ä¸­è°ƒç”¨ nextMatchId() â€” ID åŒé‡æ¶ˆè€—
**æ–‡ä»¶**: `server.js` ~è¡Œ 1640
**æè¿°**: `saveHistory()` è°ƒç”¨ `nextMatchId()` å¯¼è‡´ matchId è·³è·ƒã€‚
**ä¿®å¤å»ºè®®**: ä½¿ç”¨ç‹¬ç«‹çš„ historyId ç”Ÿæˆå™¨ã€‚

### M-2: åŒæ­¥ I/O åœ¨çƒ­è·¯å¾„
**æ–‡ä»¶**: `server.js` å¤šå¤„ (`saveCounters`, `saveCredits` ç­‰)
**æè¿°**: `fs.writeFileSync` é˜»å¡äº‹ä»¶å¾ªç¯ã€‚
**ä¿®å¤å»ºè®®**: æ”¹ç”¨ `fs.promises.writeFile` + debounceã€‚

### M-3: Bot è„šæœ¬å­˜æ”¾åœ¨ä»£ç ç›®å½•
**æ–‡ä»¶**: `server.js` ~è¡Œ 610 (`BOT_SCRIPTS_DIR`)
**æè¿°**: `./bot-scripts` ä¸ä»£ç æ··åœ¨ä¸€èµ·ï¼Œéƒ¨ç½²æ—¶å¯èƒ½è¢«è¦†ç›–ã€‚
**ä¿®å¤å»ºè®®**: ç§»åˆ° `/root/snake-data/bot-scripts`ã€‚

### M-4: Edit token 30 åˆ†é’Ÿçª—å£è¿‡é•¿
**æ–‡ä»¶**: `server.js` ~è¡Œ 2525
**æè¿°**: token æœ‰æ•ˆæœŸ 30 åˆ†é’Ÿï¼Œä½¿ç”¨åä¸é”€æ¯ã€‚
**ä¿®å¤å»ºè®®**: ç¼©çŸ­åˆ° 5 åˆ†é’Ÿ + ä½¿ç”¨åé”€æ¯ã€‚

### M-5: Prediction regex è„†å¼±æ€§
**æ–‡ä»¶**: `src/App.tsx` ~è¡Œ 2100
**æè¿°**: å‰ç«¯ç”¨æ­£åˆ™åŒ¹é… displayMatchId æ ¼å¼ï¼Œæ ¼å¼å˜åŒ–ä¼šå¯¼è‡´åŒ¹é…å¤±è´¥ã€‚
**ä¿®å¤å»ºè®®**: åç«¯ç›´æ¥è¿”å› matchId æ•°å­—ã€‚

### M-6: WebSocket æ— å¿ƒè·³è¶…æ—¶
**æ–‡ä»¶**: `server.js` WebSocket å¤„ç†
**æè¿°**: æ²¡æœ‰ ping/pong æœºåˆ¶æ£€æµ‹æ–­å¼€çš„è¿æ¥ã€‚
**ä¿®å¤å»ºè®®**: å®ç° 30 ç§’é—´éš” ping/pongã€‚

### M-7: é“¾ä¸Šç»“ç®—å¤±è´¥æ— é‡è¯•
**æ–‡ä»¶**: `server.js` ~è¡Œ 1790
**æè¿°**: `settleMatch` å¤±è´¥åä¸é‡è¯•ã€‚
**ä¿®å¤å»ºè®®**: æ·»åŠ æŒ‡æ•°é€€é¿é‡è¯•ã€‚

### M-8: å‰ç«¯è½®è¯¢é—´éš”ä¸åè°ƒ
**æ–‡ä»¶**: `src/App.tsx` å¤šå¤„
**æè¿°**: å¤šä¸ª `setInterval` ç¡¬ç¼–ç ä¸”ä¸åè°ƒã€‚
**ä¿®å¤å»ºè®®**: ç»Ÿä¸€è½®è¯¢ç®¡ç† + å¯è§æ€§ APIã€‚

### M-9: å¤šä¸ª useEffect ç¼ºå°‘æ¸…ç†
**æ–‡ä»¶**: `src/App.tsx` å¤šå¤„
**æè¿°**: éƒ¨åˆ† `setInterval` å’Œäº‹ä»¶ç›‘å¬å™¨æœªæ­£ç¡®æ¸…ç†ã€‚
**ä¿®å¤å»ºè®®**: ç¡®ä¿æ¯ä¸ª useEffect éƒ½æœ‰å¯¹åº”æ¸…ç†ã€‚

---

## ğŸŸ¢ Low (7)

### L-1: å•ä¸€ RPC ç«¯ç‚¹
æœåŠ¡ç«¯ä»…ä½¿ç”¨ä¸€ä¸ª Base Sepolia RPCï¼Œæ— æ•…éšœè½¬ç§»ã€‚

### L-2: guideUrl å¯èƒ½ 404
æŒ‡å‘å¤–éƒ¨æ–‡æ¡£çš„é“¾æ¥æœªéªŒè¯å¯ç”¨æ€§ã€‚

### L-3: decodeBytes32String å¯èƒ½æŠ›å¼‚å¸¸
éƒ¨åˆ† `ethers.decodeBytes32String()` è°ƒç”¨æœªè¢« try-catch åŒ…è£¹ã€‚

### L-4: å‰ç«¯ WebSocket é‡è¿æ— ä¸Šé™
æ–­å¼€åè‡ªåŠ¨é‡è¿ä½†æ— æœ€å¤§é‡è¯•é™åˆ¶ã€‚

### L-5: console.log æ®‹ç•™
å¤§é‡è°ƒè¯•è¯­å¥æ®‹ç•™åœ¨ç”Ÿäº§ä»£ç ä¸­ã€‚

### L-6: ç¯å¢ƒå˜é‡æ— å¯åŠ¨æ—¶æ ¡éªŒ
ç¼ºå°‘å¯¹ `PRIVATE_KEY`ã€`RPC_URL` ç­‰å¿…è¦å˜é‡çš„æ£€æŸ¥ã€‚

### L-7: CORS é…ç½®è¿‡äºå®½æ¾
å…è®¸æ‰€æœ‰æ¥æº (`*`)ã€‚

---

## ä¼˜å…ˆä¿®å¤å»ºè®®

### ğŸ”¥ ç«‹å³ä¿®å¤ (ä»Šå¤©)
1. âœ… **H-1**: ç§»é™¤ App.tsx handleCancel ç¡¬ç¼–ç  gas â€” **å·²ä¿®å¤**
2. **C-2**: admin create-on-chain æ”¹ç”¨ `enqueueTxAsync()`ï¼ˆ5 åˆ†é’Ÿï¼‰
3. **H-8**: `settledOnChainMatchIds` æ”¹ä¸º Setï¼ˆ2 åˆ†é’Ÿï¼‰

### âš¡ çŸ­æœŸä¿®å¤ (æœ¬å‘¨)
4. **C-1**: admin reset æ¸…é™¤ nextMatch
5. **C-3**: matchNumber æŒä¹…åŒ–
6. **H-2**: æ³¨å†Œå¥–åŠ±ç«æ€ä¿®å¤
7. **H-3**: credit æ‰£å‡ç«æ€ä¿®å¤
8. **H-6**: credits å…ˆæ£€æŸ¥åæ‰£é™¤

### ğŸ“‹ ä¸­æœŸä¼˜åŒ– (ä¸‹å‘¨)
9. **H-4/H-5**: å†…å­˜æ•°æ®å®šæœŸæ¸…ç†
10. **M-2**: å¼‚æ­¥æ–‡ä»¶ I/O
11. **M-6**: WebSocket å¿ƒè·³
12. **M-4**: edit token ç¼©çŸ­ + ä½¿ç”¨åé”€æ¯
